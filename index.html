<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Ultra V7 - All Commands & Precision Metrics</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #010409;
            --sidebar: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --accent: #2f81f7;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --success: #238636;
            --danger: #da3633;
            --warning: #d29922;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Global font size increase */
        .sidebar,
        .content,
        .modal,
        .card,
        .stat-card,
        table {
            font-size: 14px;
        }

        /* Sidebar - The Full Monty */
        .sidebar {
            width: 320px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .side-head {
            padding: 25px;
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
        }

        .side-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .cat {
            margin-bottom: 20px;
        }

        .cat-ttl {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 5px;
        }

        .btn-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .btn-list-inline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin: 5px 0 10px 0;
            padding: 0 5px;
        }

        .btn-item-sm {
            background: #0d1117;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 5px 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: 0.2s;
        }

        .btn-item-sm:hover {
            border-color: var(--accent);
            color: white;
            background: #161b22;
        }

        .btn-item {
            padding: 9px 12px;
            font-size: 12px;
            color: var(--text-dim);
            background: transparent;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-item:hover {
            background: rgba(47, 129, 247, 0.1);
            color: var(--accent);
        }

        .btn-item i {
            width: 14px;
            text-align: center;
            font-size: 12px;
        }

        /* Main View */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-row {
            height: 75px;
            background: rgba(1, 4, 9, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 30px;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .search-container {
            position: relative;
            width: 400px;
        }

        .search-container input {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #0d1117;
            padding: 10px 15px 10px 40px;
            color: white;
            outline: none;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
        }

        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
            gap: 20px;
        }

        /* Ultra Detailed Card */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 22px;
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .card-fav {
            border-color: #f59e0b !important;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }

        .filter-btn {
            background: var(--dark-mid);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: var(--accent-low);
            border-color: var(--accent);
            color: white;
        }

        .card-h {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .symbol {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
            font-family: 'JetBrains Mono';
        }

        .price {
            font-size: 22px;
            font-weight: 700;
            color: white;
        }

        /* Top Indicators (Fix: Rounded to 2 decimals) */
        .indicators {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .ind {
            background: #0d1117;
            padding: 10px 5px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .ind-l {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
            display: block;
        }

        .ind-v {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .matrix {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
            margin-top: 5px;
        }

        .matrix th {
            color: var(--text-dim);
            text-align: left;
            padding: 6px 4px;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }

        .matrix td {
            padding: 6px 4px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .tf {
            color: var(--accent);
            font-weight: 700;
            font-size: 12px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
        }

        .pill {
            font-size: 10px;
            padding: 4px 8px;
            background: #161b22;
            border-radius: 6px;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .pill b {
            color: white;
            margin-left: 2px;
        }

        .ai-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.5;
            border-left: 3px solid var(--accent);
            color: #abb2bf;
        }

        /* Modal Window */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-inner {
            background: var(--sidebar);
            width: 90%;
            max-width: 1000px;
            height: 85vh;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-h {
            padding: 20px 30px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-b {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            color: #7ee787;
            font-size: 14px;
            line-height: 1.6;
        }

        .copy-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* Notification Badge */
        .btn-item {
            position: relative;
        }

        .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            background: #ff4757;
            border-radius: 50%;
            display: none;
            /* Hidden by default */
            box-shadow: 0 0 5px #ff4757;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            border-left: 4px solid var(--accent);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* News Ticker */
        .news-ticker {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid var(--border);
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .ticker-label {
            background: var(--accent);
            color: #0f172a;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 20px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 101;
        }

        .ticker-content {
            white-space: nowrap;
            display: inline-block;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
            color: white;
            font-size: 13px;
        }

        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Market Regime Banner */
        .top-stats-container {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            align-items: stretch;
        }

        .regime-banner {
            flex: 1;
            background: linear-gradient(135deg, var(--regime-color, #6b7280) 0%, rgba(0, 0, 0, 0.3) 100%);
            border: 2px solid var(--regime-color, #6b7280);
            border-radius: 12px;
            padding: 12px 20px;
            margin: 0 !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: regimePulse 2s ease-in-out infinite;
            min-width: 0;
        }

        @keyframes regimePulse {

            0%,
            100% {
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 8px 48px var(--regime-color);
            }
        }

        .regime-title {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .regime-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .regime-strategy {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            border-left: 3px solid var(--regime-color);
        }

        .confidence-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: var(--regime-color);
            transition: width 0.5s ease;
        }

        /* Money Flow Section */
        .money-flow-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flow-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .flow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .flow-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .flow-item.inflow {
            border-left-color: #10b981;
        }

        .flow-item.outflow {
            border-left-color: #ef4444;
        }

        .flow-coin {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .flow-amount {
            font-size: 20px;
            font-weight: 900;
            margin: 5px 0;
        }

        .flow-trend {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Market Cash Flow Grid */
        .cash-flow-dashboard {
            flex: 1.5;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin: 0 !important;
        }

        .cash-item {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(0, 0, 0, 0.3));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .cash-item::before {
            content: 'üí∞';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 14px;
            opacity: 0.3;
        }

        .cash-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .cash-tf {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .cash-val {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .cash-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
        }

        .cash-fill {
            height: 100%;
            transition: width 1s ease, background 0.5s ease;
        }

        /* Signal Badge */
        .signal-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .badge-excellent {
            background: #10b981;
            color: white;
        }

        .badge-good {
            background: #3b82f6;
            color: white;
        }

        .badge-fair {
            background: #f59e0b;
            color: white;
        }

        .badge-poor {
            background: #ef4444;
            color: white;
        }

        .badge-new {
            background: #8b5cf6;
            color: white;
        }

        /* ========== MOBILE RESPONSIVE ========== */

        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                overflow-x: auto;
                white-space: nowrap;
            }

            .main {
                width: 100%;
                margin-left: 0;
            }

            .cat {
                display: inline-block;
                width: 250px;
                vertical-align: top;
                white-space: normal;
                margin-right: 10px;
            }

            .grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
            }

            .top-stats-container {
                flex-direction: column;
                gap: 10px;
            }

            .regime-banner {
                padding: 15px 20px;
                margin: 0 !important;
            }

            .regime-title {
                font-size: 20px;
            }

            .flow-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Mobile (max-width: 768px) */
        @media (max-width: 768px) {
            body {
                font-size: 13px;
            }

            .logo {
                font-size: 18px;
                padding: 12px 15px;
            }

            .sidebar {
                padding: 10px;
            }

            .cat {
                width: 200px;
                margin-right: 8px;
            }

            .cat-ttl {
                font-size: 11px;
                padding: 8px 10px;
            }

            .btn-item {
                padding: 10px 12px;
                font-size: 12px;
            }

            .btn-item i {
                font-size: 14px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .symbol {
                font-size: 16px;
            }

            .price {
                font-size: 18px;
            }

            .matrix {
                font-size: 11px;
            }

            .matrix th,
            .matrix td {
                padding: 5px 4px;
            }

            /* Regime Banner Mobile */
            .regime-banner {
                padding: 12px 15px;
                margin: 10px;
                border-radius: 8px;
            }

            .regime-title {
                font-size: 16px;
                gap: 6px;
            }

            .regime-desc {
                font-size: 12px;
                margin-bottom: 10px;
            }

            .regime-strategy {
                padding: 10px;
                font-size: 11px;
            }

            /* Money Flow Mobile */
            .money-flow-container {
                padding: 12px;
                margin: 10px;
            }

            .flow-title {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .flow-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .flow-item {
                padding: 12px;
            }

            .flow-coin {
                font-size: 14px;
            }

            .flow-amount {
                font-size: 18px;
            }

            /* Modal Mobile */
            .modal-inner {
                width: 95%;
                max-height: 90vh;
                margin: 20px;
            }

            .modal-b {
                font-size: 12px;
                padding: 15px;
            }

            /* Top Row Mobile */
            .top-row {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .search-container {
                width: 100%;
            }

            .search-container input {
                width: 100%;
                font-size: 14px;
                padding: 10px 10px 10px 35px;
            }

            /* News Ticker Mobile */
            .news-ticker {
                height: 35px;
                margin: 0;
            }

            .ticker-label {
                font-size: 10px;
                padding: 0 10px;
            }

            .ticker-content {
                font-size: 11px;
            }

            /* Toast Mobile */
            .toast {
                width: 90%;
                margin: 10px auto;
                font-size: 12px;
                padding: 12px;
            }

            /* Badge Mobile */
            .badge {
                width: 10px;
                height: 10px;
                font-size: 7px;
            }
        }

        /* Small Mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .logo {
                font-size: 14px;
                padding: 10px 12px;
            }

            .cat {
                width: 160px;
            }

            .regime-title {
                font-size: 14px;
                flex-direction: column;
                align-items: flex-start;
            }

            .regime-strategy {
                font-size: 10px;
            }

            .flow-amount {
                font-size: 16px;
            }

            .card {
                padding: 12px;
            }

            .matrix {
                font-size: 9px;
            }

            .matrix th,
            .matrix td {
                padding: 3px 2px;
            }

            .pill {
                font-size: 9px;
                padding: 3px 6px;
            }

            .btn-item {
                padding: 8px 10px;
                font-size: 11px;
            }
        }

        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {

            .btn-item,
            .card,
            .flow-item {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
            }

            .btn-item:active {
                transform: scale(0.98);
            }

            .card:active {
                transform: scale(0.99);
            }
        }

        /* RSI Heatmap Styles */
        .rsi-heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .rsi-card {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .rsi-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .rsi-val {
            font-size: 18px;
            font-weight: bold;
            display: block;
            margin: 5px 0;
        }

        .rsi-coin {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        .rsi-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-item .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div class="sidebar">
        <div class="side-head"><i class="fas fa-satellite-dish"></i> RADAR ULTRA V7 AI</div>
        <div class="side-scroll">

            <div class="cat">
                <div class="cat-ttl">üè† MAIN MENU</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('Current Analysis')"><i class="fas fa-home"></i> Current
                        Analysis</button>
                    <button class="btn-item" onclick="api('Summary')"><i class="fas fa-file-alt"></i> Market
                        Summary</button>
                    <button class="btn-item" id="alertBtn" onclick="api('Market Alerts')">
                        <i class="fas fa-bell"></i> Market Signals
                        <span class="badge" id="alertBadge"></span>
                    </button>
                    <button class="btn-item" onclick="api('Significant Changes')"><i class="fas fa-bolt"></i>
                        Significant Changes</button>
                    <button class="btn-item" onclick="api('Hourly Analysis')"><i class="fas fa-history"></i> Hourly
                        Analysis</button>
                    <button class="btn-item" onclick="api('Cash Flow Report')"><i class="fas fa-money-bill-wave"></i>
                        Cash Flow Report</button>
                    <button class="btn-item" onclick="api('Flow Migrations')"><i class="fas fa-exchange-alt"></i> Flow
                        Migrations</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üêã WHALE & LIQUIDITY</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('Whale Movement')"><i class="fas fa-whale"></i> Whale
                        Movement</button>
                    <button class="btn-item" onclick="api('Net Accum')"><i class="fas fa-piggy-bank"></i> Net
                        Accumulation</button>
                    <button class="btn-item" onclick="api('Smart Money')"><i class="fas fa-brain"></i> Smart
                        Money</button>
                    <button class="btn-item" onclick="api('Whale Ranking')"><i class="fas fa-trophy"></i> Whale
                        Ranking</button>
                    <button class="btn-item" onclick="api('MM Analysis')"><i class="fas fa-chart-line"></i> MM
                        Analysis</button>
                    <button class="btn-item" onclick="api('Manipulation Detector')"><i class="fas fa-mask"></i>
                        Manipulation Detector</button>
                    <button class="btn-item" onclick="api('Taker Rate')"><i class="fas fa-shopping-cart"></i> Taker
                        Buy/Sell Ratio</button>
                    <button class="btn-item" onclick="api('Significant Changes')"><i class="fas fa-bolt"></i>
                        Significant Changes</button>
                    <button class="btn-item" onclick="api('S/R Levels')"><i class="fas fa-layer-group"></i> Support /
                        Resistance</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">‚è±Ô∏è TIME-FRAME CHANGES</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('15m Change')"><i class="fas fa-bolt"></i> 15m Price
                        Change</button>
                    <button class="btn-item" onclick="api('1H Change')"><i class="fas fa-clock"></i> 1H Price
                        Change</button>
                    <button class="btn-item" onclick="api('4H Change')"><i class="fas fa-clock"></i> 4H Price
                        Change</button>
                    <button class="btn-item" onclick="api('Weekly Change')"><i class="fas fa-calendar-week"></i> Weekly
                        Change</button>
                    <button class="btn-item" onclick="api('Monthly Change')"><i class="fas fa-calendar-alt"></i> Monthly
                        Change</button>
                    <button class="btn-item" onclick="api('24h Volume')"><i class="fas fa-chart-line"></i> 24h Volume
                        ($)</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üìà TECHNICALS (RSI)</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('RSI 1H')"><i class="fas fa-clock"></i> RSI (1H)</button>
                    <button class="btn-item" onclick="api('RSI 4H')"><i class="fas fa-history"></i> RSI (4H)</button>
                    <button class="btn-item" onclick="api('RSI 1D')"><i class="fas fa-calendar-day"></i> RSI
                        (1D)</button>
                </div>
            </div>

            <!-- Volume & Support -->
            <div class="cat">
                <div class="cat-ttl">Volume & Support</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('24h Volume')">
                        <i class="fas fa-chart-bar"></i> 24H VOLUME
                    </button>
                    <button class="btn-item" onclick="api('Volume Ratio')">
                        <i class="fas fa-layer-group"></i> VOLUME RATIO
                    </button>
                    <button class="btn-item" onclick="api('Taker Rate')">
                        <i class="fas fa-hand-holding-usd"></i> TAKER RATE
                    </button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üìä MACD & ADX</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('MACD 1H')"><i class="fas fa-sliders-h"></i> MACD
                        (1H)</button>
                    <button class="btn-item" onclick="api('MACD 4H')"><i class="fas fa-sliders-h"></i> MACD
                        (4H)</button>
                    <button class="btn-item" onclick="api('Taker Rate')"><i class="fas fa-shopping-cart"></i> Taker
                        Buy/Sell Ratio</button>
                    <button class="btn-item" onclick="api('Liq Heatmap Summary')"><i class="fas fa-fire"></i>
                        Liquidation
                        Map</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üî≠ PREDICTIVE ENGINE (V3)</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('OI Change')" style="border-left: 2px solid var(--accent);"><i
                            class="fas fa-chart-bar"></i> OI Change (Lead)</button>
                    <button class="btn-item" onclick="api('Open Interest')"><i class="fas fa-layer-group"></i> Open
                        Interest</button>
                    <button class="btn-item" onclick="api('Smart Money Indicators')"><i class="fas fa-microchip"></i>
                        Deep Analysis</button>
                    <button class="btn-item" onclick="api('Arbitrage Report')"><i class="fas fa-balance-scale"></i>
                        Arbitrage</button>
                    <button class="btn-item" onclick="api('Global Analysis')"><i class="fas fa-globe"></i> Global
                        Market</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üß¨ OTHER INDICATORS</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('Smart Money Indicators')"
                        style="border-left: 3px solid #10b981;">
                        <i class="fas fa-brain"></i> üß† Smart Money (Whale+OI+Funding)
                    </button>
                    <button class="btn-item" onclick="api('EMA Report')"><i class="fas fa-project-diagram"></i> EMA
                        Trend Status</button>
                    <button class="btn-item" onclick="api('EMA Crossings')"><i class="fas fa-times-circle"></i> EMA
                        Crossings</button>
                    <button class="btn-item" onclick="api('MFI')"><i class="fas fa-tint"></i> MFI (Money Flow)</button>
                    <button class="btn-item" onclick="api('Momentum')"><i class="fas fa-rocket"></i> Momentum
                        Analysis</button>
                    <button class="btn-item" onclick="api('Bollinger Squeeze')"><i class="fas fa-compress-alt"></i>
                        Bollinger Squeeze</button>
                    <button class="btn-item" onclick="api('Order Block')"><i class="fas fa-cube"></i> Order Block
                        Analysis</button>
                    <button class="btn-item" onclick="api('Liq Heat Map')"><i class="fas fa-fire"></i> Liq Heat Map
                        (Global)</button>
                    <button class="btn-item" onclick="api('Candle Patterns')"><i class="fas fa-fire-alt"></i>
                        Candlestick Patterns</button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üõ°Ô∏è RISK, SCORE & CORR</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('Risk Analysis', event)"><i class="fas fa-shield-alt"></i>
                        Market
                        Risk Index</button>
                    <button class="btn-item" onclick="api('Smart Score', event)"><i class="fas fa-lightbulb"></i> Smart
                        Score</button>
                    <button class="btn-item" onclick="api('Composite Score', event)"><i class="fas fa-star"></i>
                        Composite
                        Score</button>
                    <button class="btn-item" onclick="api('Outlier Score', event)"><i
                            class="fas fa-exclamation-triangle"></i>
                        Outlier Score</button>
                    <div style="font-size: 11px; margin-top: 10px; color: var(--text-dim);">BTC CORRELATION</div>
                    <div class="btn-list-inline">
                        <button class="btn-item-sm" onclick="api('BTC Correlation', event)">1H</button>
                        <button class="btn-item-sm" onclick="api('BTC Correlation 4H', event)">4H</button>
                        <button class="btn-item-sm" onclick="api('BTC Correlation 1D', event)">1D</button>
                    </div>
                    <div style="font-size: 11px; margin-top: 5px; color: var(--text-dim);">ETH CORRELATION</div>
                    <div class="btn-list-inline">
                        <button class="btn-item-sm" onclick="api('ETH Correlation', event)">1H</button>
                        <button class="btn-item-sm" onclick="api('ETH Correlation 4H', event)">4H</button>
                        <button class="btn-item-sm" onclick="api('ETH Correlation 1D', event)">1D</button>
                    </div>
                    <div style="font-size: 11px; margin-top: 5px; color: var(--text-dim);">SOL CORRELATION</div>
                    <div class="btn-list-inline">
                        <button class="btn-item-sm" onclick="api('SOL Correlation', event)">1H</button>
                        <button class="btn-item-sm" onclick="api('SOL Correlation 4H', event)">4H</button>
                        <button class="btn-item-sm" onclick="api('SOL Correlation 1D', event)">1D</button>
                    </div>
                </div>
            </div>
            <div class="cat">
                <div class="cat-ttl" style="color: #10b981;">üõ∏ EXPERT STRATEGIES</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('Antigravity PA')" style="border-left: 3px solid #10b981;">
                        <i class="fas fa-rocket"></i> Master Antigravity PA
                    </button>
                    <button class="btn-item" onclick="api('TVL Alpha')" style="border-left: 3px solid #8b5cf6;">
                        <i class="fas fa-chart-pie"></i> TVL Alpha (DeFiLlama)
                    </button>
                    <button class="btn-item" onclick="api('Pump Predictions')" style="border-left: 3px solid #f59e0b;">
                        <i class="fas fa-bullseye"></i> Master Pump Predictions (AI)
                    </button>
                    <button class="btn-item" onclick="loadCalendar()" style="border-left: 3px solid #3b82f6;">
                        <i class="fas fa-calendar-alt"></i> üìÖ Market Calendar
                    </button>
                </div>
            </div>

            <div class="cat">
                <div class="cat-ttl">üì∫ AI & EXPORT</div>
                <div class="btn-list">
                    <button class="btn-item" onclick="api('YouTube Alpha', event)"><i class="fab fa-youtube"></i>
                        YouTube
                        Alpha</button>
                    <button class="btn-item" onclick="api('YouTube Transcripts', event)"><i
                            class="fas fa-file-audio"></i>
                        YouTube Transcripts</button>
                    <button class="btn-item" onclick="api('NotebookLM Export', event)"><i class="fas fa-robot"></i>
                        NotebookLM
                        AI Export</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="news-ticker" id="tickerWrap">
            <span class="ticker-label">Live Signals</span>
            <div class="ticker-content" id="liveTicker">Initializing live market feed... Searching for technical
                breakouts...</div>
        </div>
        <div class="top-row">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search" placeholder="BTC, ETH, 70, Bullish...">
                <div style="display: flex; gap: 5px; margin-left: 10px;">
                    <button class="filter-btn" id="favFilter" onclick="toggleFilter('fav')">‚≠ê FAVORITES</button>
                    <button class="filter-btn" id="futureFilter" onclick="toggleFilter('future')">üîÆ WATCH
                        SIGNALS</button>
                    <button class="filter-btn" onclick="openRsiHeatmap()"
                        style="background: linear-gradient(135deg, #8b5cf6, #6366f1); border-color: #8b5cf6;">üìä RSI
                        HEATMAP</button>
                    <button class="filter-btn" onclick="loadCalendar()"
                        style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-color: #3b82f6;">üìÖ
                        CALENDAR</button>
                    <button class="filter-btn" onclick="loadNews()"
                        style="background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981;">üì∞
                        NEWS</button>
                    <button class="filter-btn" onclick="openTradeDoctor()"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706); border-color: #f59e0b;">ü©∫
                        TRADE DOCTOR</button>
                    <button class="filter-btn" onclick="loadWhales()"
                        style="background: linear-gradient(135deg, #06b6d4, #0891b2); border-color: #06b6d4;">üêã
                        WHALES</button>
                    <button class="filter-btn" onclick="openScamDetector()"
                        style="background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #ef4444;">üõ°Ô∏è
                        SCAM CHECK</button>
                    <button class="filter-btn" onclick="openElliottWave()"
                        style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: #8b5cf6;">üåä
                        ELLIOTT WAVE</button>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; color: #3fb950; font-size: 13px;">‚óè MARKET RADAR ACTIVE</div>
                <div id="uTime" style="font-size: 11px; color: var(--text-dim);">--:--:--</div>
            </div>
        </div>

        <div class="content">
            <div class="top-stats-container">
                <div id="regimeBanner" class="regime-banner">
                    <div class="regime-title">
                        <span id="regimeEmoji">üîÑ</span> <span id="regimeDisplay">ANALYZING MARKET...</span>
                    </div>
                    <div id="regimeDesc" class="regime-desc">Gathering real-time market data and processing AI signals.
                    </div>
                    <div id="regimeStrategy" class="regime-strategy">Wait for signal...</div>
                    <div class="confidence-bar">
                        <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="cashFlowDashboard" class="cash-flow-dashboard"
                    title="Market Cash Flow: Buyer Ratio (Taker Buy Volume / Total Volume). >50% = Buyer Pressure, <50% = Seller Pressure">
                    <div class="cash-item">
                        <div class="cash-tf">15m FLOW</div>
                        <div id="flow-15m-val" class="cash-val">--%</div>
                        <div class="cash-bar">
                            <div id="flow-15m-fill" class="cash-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="cash-item">
                        <div class="cash-tf">1h FLOW</div>
                        <div id="flow-1h-val" class="internal-cash-val">--%</div>
                        <div class="cash-bar">
                            <div id="flow-1h-fill" class="cash-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="cash-item">
                        <div class="cash-tf">4h FLOW</div>
                        <div id="flow-4h-val" class="internal-cash-val">--%</div>
                        <div class="cash-bar">
                            <div id="flow-4h-fill" class="cash-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="cash-item">
                        <div class="cash-tf">12h FLOW</div>
                        <div id="flow-12h-val" class="internal-cash-val">--%</div>
                        <div class="cash-bar">
                            <div id="flow-12h-fill" class="cash-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="cash-item">
                        <div class="cash-tf">1d FLOW</div>
                        <div id="flow-1d-val" class="internal-cash-val">--%</div>
                        <div class="cash-bar">
                            <div id="flow-1d-fill" class="cash-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="moneyFlowSection" class="money-flow-container" style="display: none;">
                <div class="flow-title">üåä WHALE MONEY FLOW (RT)</div>
                <div id="flowGrid" class="flow-grid"></div>
            </div>

            <div id="grid" class="grid"></div>
        </div>
    </div>

    <!-- RSI Heatmap Modal -->
    <div id="rsiHeatmapModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>üìä RSI Heatmap (Top 50)</h2>
                <span class="close" onclick="closeRsiHeatmap()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="rsiHeatmapGrid" class="rsi-heatmap-container">
                    <!-- Dynamic Content -->
                </div>
                <div class="rsi-legend">
                    <span class="legend-item"><span class="dot" style="background:#ef4444"></span>Overbought
                        (>70)</span>
                    <span class="legend-item"><span class="dot" style="background:#f97316"></span>Strong (60-70)</span>
                    <span class="legend-item"><span class="dot" style="background:#eab308"></span>Neutral (40-60)</span>
                    <span class="legend-item"><span class="dot" style="background:#3b82f6"></span>Weak (30-40)</span>
                    <span class="legend-item"><span class="dot" style="background:#10b981"></span>Oversold (<30)< /span>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-inner">
            <div class="modal-h">
                <h3 id="modalT" style="color: var(--accent);" translate="no">Report</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="popupSearch" placeholder="üîç Search coin..." onkeyup="filterPopup()"
                        style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--dark-mid); color: var(--text); font-size: 13px; width: 150px;">
                    <button class="copy-btn" onclick="copyM()" translate="no"><i class="fas fa-copy"></i> COPY
                        REPORT</button>
                    <button onclick="closeM()"
                        style="background:transparent; border:none; color:white; font-size:28px; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div class="modal-b" id="modalB">Loading...</div>
        </div>
    </div>

    <script>
        let db = [];
        let lastAlertTime = parseFloat(localStorage.getItem('lastAlertTime')) || 0;
        const fmt = (v, d = 2) => (v === undefined || v === null || v === "N/A") ? "N/A" : (typeof v === 'number' ? v.toFixed(d) : (parseFloat(v) || 0).toFixed(d));

        async function pull() {
            try {
                const r = await fetch('/api/data');
                const d = await r.json();
                if (d && d.length > 0) {
                    db = d;
                    draw();
                    document.getElementById('uTime').innerText = 'SYNC UPDATE: ' + new Date().toLocaleTimeString();
                }
            } catch (e) { console.error(e); }
        }

        // FAVORƒ∞ Sƒ∞STEMƒ∞
        let favorites = JSON.parse(localStorage.getItem('coinFavorites')) || [];
        let activeFilters = { fav: false, future: false };

        function toggleFilter(type) {
            activeFilters[type] = !activeFilters[type];
            document.getElementById(type + 'Filter').classList.toggle('active', activeFilters[type]);
            draw();
        }

        function toggleFavorite(coin) {
            if (favorites.includes(coin)) {
                favorites = favorites.filter(c => c !== coin);
            } else {
                favorites.push(coin);
            }
            localStorage.setItem('coinFavorites', JSON.stringify(favorites));
            draw();
        }

        function isFavorite(coin) {
            return favorites.includes(coin);
        }

        // GELECEK TAHMƒ∞N SKORU
        function getFutureScore(c) {
            let score = 0;
            let reasons = [];

            // RSI dipte + momentum pozitif = fƒ±rsat
            const rsi = parseFloat(c.RSI) || 50;
            if (rsi < 35) { score += 25; reasons.push("Oversold RSI"); }
            else if (rsi > 70) { score -= 10; } // Overbought reduces watch score

            // Volume patlamasƒ± = dikkat
            const volRatio = parseFloat(c['Volume Ratio']) || 1;
            if (volRatio > 2) { score += 20; reasons.push("Volume Surge üìà"); }

            // Net Accumulation pozitif = balinalar alƒ±yor
            const netAccum = parseFloat(c.NetAccum_raw) || 0;
            if (netAccum > 50000) { score += 20; reasons.push("Whale Buying üêã"); }

            // Bollinger Squeeze = patlama bekle
            if (c.BB_Squeeze === "Squeeze üî•" || c.BB_Squeeze === "Squeeze") { score += 20; reasons.push("BB Squeeze üí•"); }

            // OI artƒ±≈üƒ± = pozisyon birikiyor
            const oi_change = parseFloat(c['OI Change %']) || 0;
            if (oi_change > 5) { score += 15; reasons.push("OI Increasing"); }

            return { score: Math.min(score, 100), reasons };
        }

        function draw() {
            const grid = document.getElementById('grid');
            const q = document.getElementById('search').value.toUpperCase();
            grid.innerHTML = '';

            // 1. Initial filter by search query
            let filtered = db.filter(c => (c.Coin + (c.Advice || '')).toUpperCase().includes(q));

            // 2. Attach future data
            filtered = filtered.map(c => ({ ...c, _futureData: getFutureScore(c) }));

            // 3. Apply toggles
            if (activeFilters.fav) filtered = filtered.filter(c => isFavorite(c.Coin));
            if (activeFilters.future) filtered = filtered.filter(c => c._futureData.score >= 50);

            // 4. Sort: Favorites first, then Score
            filtered.sort((a, b) => {
                const aFav = isFavorite(a.Coin) ? 1 : 0;
                const bFav = isFavorite(b.Coin) ? 1 : 0;
                if (aFav !== bFav) return bFav - aFav;
                return b._futureData.score - a._futureData.score;
            });

            filtered.forEach(c => {
                const chg = parseFloat(c['24h Change']);
                const futureData = c._futureData;
                const isFav = isFavorite(c.Coin);
                const card = document.createElement('div');
                card.className = 'card' + (isFav ? ' card-fav' : '');

                // Future alert banner
                let futureBanner = '';
                if (futureData.score >= 50) {
                    futureBanner = `<div style="background: linear-gradient(90deg, #059669, #10b981); padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; font-size: 11px; color: white;">
                        üîÆ <b>WATCH SIGNAL (${futureData.score})</b>: ${futureData.reasons.slice(0, 3).join(' ‚Ä¢ ')}
                    </div>`;
                } else if (futureData.score >= 30) {
                    futureBanner = `<div style="background: linear-gradient(90deg, #b45309, #f59e0b); padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; font-size: 11px; color: white;">
                        üëÄ <b>DEVELOPING (${futureData.score})</b>: ${futureData.reasons.slice(0, 2).join(' ‚Ä¢ ')}
                    </div>`;
                }

                card.innerHTML = `
                    ${futureBanner}
                    <div class="card-h">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="toggleFavorite('${c.Coin}')" style="background:none; border:none; cursor:pointer; font-size:18px; padding:0;">
                                ${isFav ? '‚≠ê' : '‚òÜ'}
                            </button>
                            <div>
                                <div class="symbol">${c.DisplaySymbol}</div>
                                <div style="font-size:9px; opacity:0.7;">${c.Dominant_Exchange ? c.Dominant_Exchange.toUpperCase() : 'BINANCE'}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div class="price">${c.Price_Display}</div>
                            ${c.Global_Price ? `<div style="font-size:10px; opacity:0.8;">üåç $${fmt(c.Global_Price)}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="font-size: 14px; font-weight: 700; color: ${chg >= 0 ? '#3fb950' : '#f85149'};">
                        24h Change: ${chg >= 0 ? '+' : ''}${fmt(chg, 2)}%
                    </div>

                    <div class="indicators">
                        <div class="ind"><span class="ind-l">RSI</span><span class="ind-v">${fmt(c.RSI, 2)}</span></div>
                        <div class="ind"><span class="ind-l">MACD</span><span class="ind-v">${fmt(c.MACD, 2)}</span></div>
                        <div class="ind"><span class="ind-l">ADX</span><span class="ind-v">${fmt(c.ADX, 2)}</span></div>
                        <div class="ind"><span class="ind-l">MFI</span><span class="ind-v">${fmt(c.MFI, 2)}</span></div>
                    </div>

                    <table class="matrix">
                        <tr><th>TF</th><th>RSI</th><th>MACD</th><th>ADX</th><th>Z-SC</th><th>ACCUM</th></tr>
                        <tr><td class="tf">1H</td><td>${fmt(c.RSI, 1)}</td><td>${fmt(c.MACD, 1)}</td><td>${fmt(c.ADX, 1)}</td><td>${fmt(c['Z-Score'], 2)}</td><td>${fmt(c.NetAccum_raw / 1000, 0)}k</td></tr>
                        <tr><td class="tf">4H</td><td>${fmt(c.RSI_4h, 1)}</td><td>${fmt(c.MACD_4h, 1)}</td><td>${fmt(c.ADX_4h, 1)}</td><td>${fmt(c.z_score_4h, 2)}</td><td>${fmt(c.net_accum_4h / 1000, 0)}k</td></tr>
                        <tr><td class="tf">12H</td><td>${fmt(c.rsi_12h, 1)}</td><td>${fmt(c.macd_12h, 1)}</td><td>${fmt(c.adx_12h, 1)}</td><td>${fmt(c.z_score_12h, 2)}</td><td>${fmt(c.net_accum_12h / 1000, 0)}k</td></tr>
                        <tr><td class="tf">1D</td><td>${fmt(c.RSI_1d, 1)}</td><td>${fmt(c.MACD_1d, 1)}</td><td>${fmt(c.ADX_1d, 1)}</td><td>${fmt(c.z_score_1d, 2)}</td><td>${fmt(c.net_accum_1d / 1000, 0)}k</td></tr>
                    </table>

                    <div class="tags">
                        <div class="pill">Composite: <b>${fmt(c['Composite Score'], 1)}</b></div>
                        <div class="pill">Vol Ratio: <b>${fmt(c['Volume Ratio'], 2)}x</b></div>
                        ${c.Price_Spread > 0.5 ? `<div class="pill" style="border-color:#f59e0b; color:#f59e0b;">‚ö†Ô∏è Spread: <b>${fmt(c.Price_Spread, 2)}%</b></div>` : ''}
                        <div class="pill">BTC-Corr: <b>${fmt(c['btc_corr_1h'], 2)}</b></div>
                        <div class="pill">ATR: <b>${fmt(c.ATR_raw, 4)}</b></div>
                        <div class="pill">Funding: <b>${c['Funding Rate'] || '0%'}</b></div>
                    </div>

                    <div style="font-size:11px; color:var(--text-dim); display:flex; justify-content:space-between;">
                        <span>SUP/RES: ${c['Support_Resistance'] || 'N/A'}</span>
                        <span>Momentum: ${fmt(c.Momentum, 1)}</span>
                    </div>

                    <div class="ai-box">
                        <strong><i class="fas fa-robot"></i> CURRENT ANALYSIS:</strong><br>
                        ${c.Advice || 'Waiting for analysis data...'}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Market Calendar function
        async function loadCalendar() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üìÖ MARKET CALENDAR & IMPACT ANALYSIS";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';
            b.innerHTML = "<i>Loading economic calendar, token unlocks, and news sentiment... Please wait.</i>";

            try {
                const res = await fetch('/api/calendar');
                const data = await res.json();

                if (data.error) {
                    b.innerHTML = `<span style="color: #ef4444;">Error: ${data.error}</span>`;
                    return;
                }

                let html = '';

                // Overall Status
                const outlookEmoji = data.overall_outlook === 'bullish' ? 'üü¢' : data.overall_outlook === 'bearish' ? 'üî¥' : 'üü°';
                const riskEmoji = data.risk_level === 'high' ? 'üî¥' : data.risk_level === 'medium' ? 'üü°' : 'üü¢';

                html += `<div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #3b82f6;">üìä Overall Market Status</h3>`;
                html += `<p><b>Outlook:</b> ${outlookEmoji} ${(data.overall_outlook || 'neutral').toUpperCase()}</p>`;
                html += `<p><b>Risk Level:</b> ${riskEmoji} ${(data.risk_level || 'medium').toUpperCase()}</p>`;
                html += `<p style="font-size: 11px; color: #8b949e;">Generated: ${data.generated_at || 'N/A'}</p>`;
                html += `</div>`;

                // Economic Events
                html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #10b981;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #10b981;">üèõÔ∏è Economic Events (Next 7 Days)</h3>`;
                if (data.economic_events && data.economic_events.length > 0) {
                    data.economic_events.slice(0, 10).forEach(ev => {
                        const impactIcon = ev.impact === 'high' ? 'üî¥' : ev.impact === 'medium' ? 'üü°' : '‚ö™';
                        const cryptoImpact = Math.round((ev.crypto_relevance || 0) * 100);
                        const dateStr = ev.date ? `üìÖ ${ev.date}` : '';
                        html += `<div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 6px;">`;
                        html += `<b>${impactIcon} [${ev.currency || 'N/A'}] ${ev.event || 'Unknown Event'}</b><br>`;
                        html += `<span style="font-size: 12px; color: #8b949e;">${dateStr} ‚è∞ ${ev.time || 'TBA'} | Crypto Impact: ${cryptoImpact}%</span>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #8b949e;">No major events scheduled</p>`;
                }
                html += `</div>`;

                // Token Unlocks
                html += `<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ef4444;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #ef4444;">üîì Token Unlocks (Next 30 Days)</h3>`;
                if (data.token_unlocks && data.token_unlocks.length > 0) {
                    data.token_unlocks.forEach(unlock => {
                        const daysText = unlock.days_until === 0 ? '‚ö†Ô∏è TODAY' : `in ${unlock.days_until} days`;
                        html += `<div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 6px;">`;
                        html += `<b>$${unlock.symbol}</b> - ~${unlock.unlock_pct}% unlock ${daysText}<br>`;
                        html += `<span style="font-size: 12px; color: #8b949e;">Date: ${unlock.date} | Expected: ${unlock.expected_effect || 'bearish'}</span>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #8b949e;">No major unlocks in the next 30 days</p>`;
                }
                html += `</div>`;

                // Crypto Events (Mainnet, Airdrop, Upgrade)
                html += `<div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #8b5cf6;">üöÄ Crypto Events (Mainnet, Airdrop, Upgrade)</h3>`;
                if (data.crypto_events && data.crypto_events.length > 0) {
                    data.crypto_events.forEach(ev => {
                        let typeIcon = 'üìå';
                        let typeColor = '#6b7280';
                        if (ev.type === 'mainnet') { typeIcon = 'üåê'; typeColor = '#10b981'; }
                        else if (ev.type === 'airdrop') { typeIcon = 'üéÅ'; typeColor = '#f59e0b'; }
                        else if (ev.type === 'upgrade') { typeIcon = '‚ö°'; typeColor = '#3b82f6'; }
                        else if (ev.type === 'listing') { typeIcon = 'üìà'; typeColor = '#8b5cf6'; }
                        else if (ev.type === 'conference') { typeIcon = 'üé§'; typeColor = '#ec4899'; }
                        else if (ev.type === 'burn') { typeIcon = 'üî•'; typeColor = '#ef4444'; }

                        html += `<div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${typeColor};">`;
                        html += `<b>${typeIcon} ${ev.coin || 'Unknown'}</b> - ${ev.title}<br>`;
                        html += `<span style="font-size: 12px; color: #8b949e;">üìÖ ${ev.date || 'TBA'} | <span style="color: ${typeColor}; text-transform: uppercase;">${ev.type}</span></span>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #8b949e;">No upcoming crypto events</p>`;
                }
                html += `</div>`;

                // News Sentiment
                html += `<div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #8b5cf6;">`;
                html += `<h3 style="margin: 0 0 10px 0; color: #8b5cf6;">üì∞ News Sentiment</h3>`;
                if (data.news_sentiment) {
                    const ns = data.news_sentiment;
                    html += `<p>üü¢ Bullish: <b>${ns.bullish || 0}</b> | üî¥ Bearish: <b>${ns.bearish || 0}</b> | ‚ö™ Neutral: <b>${ns.neutral || 0}</b></p>`;
                    html += `<p><b>Overall:</b> ${(ns.overall || 'neutral').toUpperCase()}</p>`;
                } else {
                    html += `<p style="color: #8b949e;">News sentiment data not available</p>`;
                }
                html += `</div>`;

                b.innerHTML = html;

            } catch (e) {
                b.innerHTML = `<span style="color: #ef4444;">Error loading calendar: ${e.message}</span>`;
            }
        }

        // Crypto News function
        async function loadNews() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üì∞ CRYPTO NEWS FEED";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';
            b.innerHTML = "<i>Loading latest crypto news from multiple sources... Please wait.</i>";

            try {
                const res = await fetch('/api/calendar');
                const data = await res.json();

                if (data.error) {
                    b.innerHTML = `<span style="color: #ef4444;">Error: ${data.error}</span>`;
                    return;
                }

                let html = '';

                // Breaking News Section
                if (data.breaking_news && data.breaking_news.length > 0) {
                    html += `<div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(0,0,0,0.3)); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ef4444;">`;
                    html += `<h3 style="margin: 0 0 10px 0; color: #ef4444;">üö® BREAKING NEWS</h3>`;
                    data.breaking_news.forEach(news => {
                        const sentimentIcon = news.sentiment === 'bullish' ? 'üü¢' : news.sentiment === 'bearish' ? 'üî¥' : '‚ö™';
                        const coins = news.coins && news.coins.length > 0 ? news.coins.map(c => `<span style="background: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px;">$${c}</span>`).join('') : '';
                        html += `<div style="padding: 10px; margin: 8px 0; background: rgba(0,0,0,0.4); border-radius: 8px; border-left: 3px solid #ef4444;">`;
                        html += `<div style="font-weight: 700; margin-bottom: 5px;">${sentimentIcon} ${news.title}</div>`;
                        html += `<div style="font-size: 11px; color: #8b949e;">${news.source} ‚Ä¢ ${news.time_ago} ${coins ? '‚Ä¢ ' + coins : ''}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                }

                // News Sentiment Summary
                if (data.news_sentiment) {
                    const ns = data.news_sentiment;
                    const total = (ns.bullish || 0) + (ns.bearish || 0) + (ns.neutral || 0);
                    const bullishPct = total > 0 ? Math.round((ns.bullish / total) * 100) : 0;
                    const bearishPct = total > 0 ? Math.round((ns.bearish / total) * 100) : 0;

                    html += `<div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">`;
                    html += `<h3 style="margin: 0 0 10px 0; color: #8b5cf6;">üìä Sentiment Analysis</h3>`;
                    html += `<div style="display: flex; gap: 20px; margin-bottom: 10px;">`;
                    html += `<div>üü¢ Bullish: <b>${ns.bullish || 0}</b> (${bullishPct}%)</div>`;
                    html += `<div>üî¥ Bearish: <b>${ns.bearish || 0}</b> (${bearishPct}%)</div>`;
                    html += `<div>‚ö™ Neutral: <b>${ns.neutral || 0}</b></div>`;
                    html += `</div>`;
                    html += `<div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">`;
                    html += `<div style="display: flex; height: 100%;">`;
                    html += `<div style="width: ${bullishPct}%; background: #10b981;"></div>`;
                    html += `<div style="width: ${bearishPct}%; background: #ef4444;"></div>`;
                    html += `</div></div>`;
                    html += `</div>`;
                }

                // All News Feed
                html += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">`;
                html += `<h3 style="margin: 0 0 15px 0; color: #3b82f6;">üì∞ Latest Headlines</h3>`;

                if (data.crypto_news && data.crypto_news.length > 0) {
                    data.crypto_news.slice(0, 20).forEach(news => {
                        const sentimentIcon = news.sentiment === 'bullish' ? 'üü¢' : news.sentiment === 'bearish' ? 'üî¥' : '‚ö™';
                        const impactBadge = news.impact_score >= 70 ? '<span style="background: #ef4444; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 8px;">HIGH IMPACT</span>' : '';
                        const coins = news.coins && news.coins.length > 0 ? news.coins.map(c => `<span style="background: rgba(59, 130, 246, 0.3); padding: 1px 5px; border-radius: 3px; font-size: 10px; margin-right: 3px;">$${c}</span>`).join('') : '';

                        // Real vote counts from CryptoPanic
                        const votesHtml = (news.votes_positive !== undefined || news.votes_negative !== undefined)
                            ? `<span style="margin-left: 8px;">üëç${news.votes_positive || 0} üëé${news.votes_negative || 0}</span>`
                            : '';

                        html += `<div style="padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid ${news.sentiment === 'bullish' ? '#10b981' : news.sentiment === 'bearish' ? '#ef4444' : '#6b7280'};">`;
                        html += `<div style="font-weight: 600; margin-bottom: 5px;">${sentimentIcon} ${news.title}${impactBadge}</div>`;
                        html += `<div style="font-size: 11px; color: #8b949e;">`;
                        html += `<span style="color: #60a5fa;">${news.source}</span> ‚Ä¢ ${news.time_ago}${votesHtml}`;
                        if (coins) html += ` ‚Ä¢ ${coins}`;
                        html += `</div>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #8b949e;">No news available at this time.</p>`;
                }
                html += `</div>`;

                b.innerHTML = html;

            } catch (e) {
                b.innerHTML = `<span style="color: #ef4444;">Error loading news: ${e.message}</span>`;
            }
        }

        // ü©∫ Trade Doctor function
        function openTradeDoctor() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "ü©∫ AI TRADE DOCTOR";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';

            b.innerHTML = `
                <div style="background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #f59e0b;">üìä Analyze Your Position</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Coin Symbol</label>
                            <input type="text" id="tdSymbol" placeholder="BTC, ETH, SOL..." 
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Position Type</label>
                            <select id="tdType" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                                <option value="long">LONG</option>
                                <option value="short">SHORT</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Entry Price ($)</label>
                            <input type="number" id="tdEntry" placeholder="95000" step="0.01"
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Quantity</label>
                            <input type="number" id="tdQuantity" placeholder="0.1" step="0.0001"
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                        </div>
                    </div>
                    <button onclick="analyzePosition()" 
                        style="margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; width: 100%;">
                        üîç ANALYZE POSITION
                    </button>
                </div>
                <div id="tdResult" style="min-height: 100px;"></div>
            `;
        }

        async function analyzePosition() {
            const symbol = document.getElementById('tdSymbol').value || 'BTC';
            const entryPrice = parseFloat(document.getElementById('tdEntry').value) || 0;
            const quantity = parseFloat(document.getElementById('tdQuantity').value) || 0;
            const positionType = document.getElementById('tdType').value || 'long';
            const resultDiv = document.getElementById('tdResult');

            if (entryPrice <= 0 || quantity <= 0) {
                resultDiv.innerHTML = '<p style="color: #ef4444;">Please enter valid entry price and quantity</p>';
                return;
            }

            resultDiv.innerHTML = '<i>Analyzing your position... Please wait.</i>';

            try {
                const res = await fetch('/api/trade-doctor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, entry_price: entryPrice, quantity, position_type: positionType })
                });
                const data = await res.json();

                if (data.error) {
                    resultDiv.innerHTML = `<span style="color: #ef4444;">Error: ${data.error}</span>`;
                    return;
                }

                const pnlColor = data.pnl.usd >= 0 ? '#10b981' : '#ef4444';
                const pnlIcon = data.pnl.usd >= 0 ? 'üìà' : 'üìâ';
                const actionColor = data.recommendation.action_raw === 'SELL' || data.recommendation.action_raw === 'CLOSE' ? '#ef4444' :
                    data.recommendation.action_raw === 'BUY_MORE' ? '#10b981' : '#f59e0b';

                let html = `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: white;">$${data.symbol} ${data.position_type.toUpperCase()}</h3>
                            <span style="font-size: 24px; font-weight: 700; color: ${pnlColor};">
                                ${pnlIcon} ${data.pnl.percentage > 0 ? '+' : ''}${data.pnl.percentage}%
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: #8b949e; font-size: 11px;">Entry</div>
                                <div style="color: white; font-weight: 600;">$${data.entry_price}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: #8b949e; font-size: 11px;">Current</div>
                                <div style="color: white; font-weight: 600;">$${data.current_price}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: #8b949e; font-size: 11px;">P&L</div>
                                <div style="color: ${pnlColor}; font-weight: 600;">$${data.pnl.usd.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: ${actionColor}22; padding: 15px; border-radius: 12px; border-left: 4px solid ${actionColor}; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0; color: ${actionColor};">${data.recommendation.action}</h3>
                        <div style="color: white; margin-bottom: 10px;">Confidence: <b>${data.recommendation.confidence}%</b></div>
                        <ul style="margin: 0; padding-left: 20px; color: #8b949e;">
                            ${data.recommendation.reasons.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #10b981;">
                            <h4 style="margin: 0 0 10px 0; color: #10b981;">üìä Technicals</h4>
                            <p style="margin: 5px 0; color: #8b949e;">RSI: <b style="color: white;">${data.technicals.rsi}</b> (${data.technicals.rsi_signal})</p>
                            <p style="margin: 5px 0; color: #8b949e;">Trend: <b style="color: white;">${data.technicals.trend.toUpperCase()}</b></p>
                            <p style="margin: 5px 0; color: #8b949e;">EMA20: <b style="color: white;">$${data.technicals.ema_20.toFixed(2)}</b></p>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <h4 style="margin: 0 0 10px 0; color: #ef4444;">üéØ Risk/Reward</h4>
                            <p style="margin: 5px 0; color: #8b949e;">Stop Loss: <b style="color: #ef4444;">$${data.risk_reward.stop_loss}</b></p>
                            <p style="margin: 5px 0; color: #8b949e;">Take Profit: <b style="color: #10b981;">$${data.risk_reward.take_profit}</b></p>
                            <p style="margin: 5px 0; color: #8b949e;">R/R Ratio: <b style="color: ${data.risk_reward.is_favorable ? '#10b981' : '#f59e0b'};">${data.risk_reward.risk_reward_ratio}:1</b></p>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = html;

            } catch (e) {
                resultDiv.innerHTML = `<span style="color: #ef4444;">Error: ${e.message}</span>`;
            }
        }

        // üêã Whale Watcher function
        async function loadWhales() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üêã WHALE WATCHER";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';
            b.innerHTML = "<i>Loading whale transactions... Please wait.</i>";

            try {
                const res = await fetch('/api/whales');
                const data = await res.json();

                if (data.error) {
                    b.innerHTML = `<span style="color: #ef4444;">Error: ${data.error}</span>`;
                    return;
                }

                let html = '';

                // Summary
                const summary = data.summary || {};
                const sentimentColor = summary.sentiment === 'bullish' ? '#10b981' : summary.sentiment === 'bearish' ? '#ef4444' : '#6b7280';
                const sentimentEmoji = summary.sentiment === 'bullish' ? 'üü¢' : summary.sentiment === 'bearish' ? 'üî¥' : '‚ö™';

                html += `<div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #06b6d4; margin-bottom: 20px;">`;
                html += `<h3 style="margin: 0 0 15px 0; color: #06b6d4;">üìä Whale Activity Summary</h3>`;
                html += `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">`;
                html += `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #8b949e; font-size: 11px;">Total Volume</div>
                    <div style="color: white; font-weight: 600;">$${(summary.total_volume_usd || 0).toLocaleString()}</div>
                </div>`;
                html += `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #8b949e; font-size: 11px;">Buy Volume</div>
                    <div style="color: #10b981; font-weight: 600;">$${(summary.buy_volume || 0).toLocaleString()}</div>
                </div>`;
                html += `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #8b949e; font-size: 11px;">Sell Volume</div>
                    <div style="color: #ef4444; font-weight: 600;">$${(summary.sell_volume || 0).toLocaleString()}</div>
                </div>`;
                html += `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #8b949e; font-size: 11px;">Sentiment</div>
                    <div style="color: ${sentimentColor}; font-weight: 600;">${sentimentEmoji} ${(summary.sentiment || 'neutral').toUpperCase()}</div>
                </div>`;
                html += `</div></div>`;

                // Alerts
                if (data.alerts && data.alerts.length > 0) {
                    html += `<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">`;
                    html += `<h3 style="margin: 0 0 10px 0; color: #ef4444;">üö® High-Value Alerts ($1M+)</h3>`;
                    data.alerts.slice(0, 5).forEach(a => {
                        html += `<div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 6px;">${a.message} ‚Ä¢ ${a.time_ago}</div>`;
                    });
                    html += `</div>`;
                }

                // Recent Transactions
                html += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 12px; border-left: 4px solid #3b82f6;">`;
                html += `<h3 style="margin: 0 0 15px 0; color: #3b82f6;">üí± Recent Large Transactions</h3>`;

                if (data.transactions && data.transactions.length > 0) {
                    data.transactions.slice(0, 15).forEach(tx => {
                        const typeColor = tx.type === 'BUY' ? '#10b981' : tx.type === 'SELL' ? '#ef4444' : '#6b7280';
                        const typeIcon = tx.type === 'BUY' ? 'üü¢' : tx.type === 'SELL' ? 'üî¥' : '‚ö™';
                        html += `<div style="padding: 10px; margin: 8px 0; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid ${typeColor};">`;
                        html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
                        html += `<span><b style="color: white;">${typeIcon} $${tx.coin}</b> <span style="color: ${typeColor};">${tx.type || 'TRANSFER'}</span></span>`;
                        html += `<span style="color: #f59e0b; font-weight: 600;">$${tx.amount_usd.toLocaleString()}</span>`;
                        html += `</div>`;
                        html += `<div style="font-size: 11px; color: #8b949e; margin-top: 5px;">${tx.amount} ${tx.coin} ‚Ä¢ ${tx.time_ago} ‚Ä¢ ${tx.source}</div>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #8b949e;">No large transactions detected recently.</p>`;
                }
                html += `</div>`;

                b.innerHTML = html;

            } catch (e) {
                b.innerHTML = `<span style="color: #ef4444;">Error loading whales: ${e.message}</span>`;
            }
        }

        // üõ°Ô∏è Scam Detector function
        function openScamDetector() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üõ°Ô∏è SCAM DETECTOR";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';

            b.innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #ef4444;">üîç Check Token Security</h3>
                    <p style="color: #8b949e; margin-bottom: 15px;">Enter token name (PEPE, SHIB, DOGE) or contract address to check for scam/rug pull.</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Token Name or Address</label>
                            <input type="text" id="scamQuery" placeholder="PEPE, SHIB, or 0x..." 
                                style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #8b949e;">Chain (optional)</label>
                            <select id="scamChain" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 6px; color: white;">
                                <option value="">Auto-Detect</option>
                                <option value="eth">Ethereum</option>
                                <option value="bsc">BNB Chain</option>
                                <option value="polygon">Polygon</option>
                                <option value="arbitrum">Arbitrum</option>
                                <option value="base">Base</option>
                                <option value="avalanche">Avalanche</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="analyzeToken()" 
                        style="margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; width: 100%;">
                        üîç SCAN FOR SCAM
                    </button>
                </div>
                <div id="scamResult" style="min-height: 100px;"></div>
            `;
        }

        async function analyzeToken() {
            const query = document.getElementById('scamQuery').value.trim();
            const chain = document.getElementById('scamChain').value;
            const resultDiv = document.getElementById('scamResult');

            if (!query || query.length < 2) {
                resultDiv.innerHTML = '<p style="color: #ef4444;">Please enter a token name or address</p>';
                return;
            }

            resultDiv.innerHTML = '<i>üîç Searching and scanning token... This may take a few seconds.</i>';

            try {
                const res = await fetch('/api/scam-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, chain })
                });
                const data = await res.json();

                if (data.error) {
                    resultDiv.innerHTML = `<span style="color: #ef4444;">Error: ${data.error}</span>`;
                    return;
                }

                const riskColor = data.risk_level === 'CRITICAL' ? '#ef4444' :
                    data.risk_level === 'HIGH' ? '#f97316' :
                        data.risk_level === 'MEDIUM' ? '#f59e0b' :
                            data.risk_level === 'LOW' ? '#84cc16' : '#10b981';

                const riskEmoji = data.risk_level === 'CRITICAL' ? 'üö®' :
                    data.risk_level === 'HIGH' ? '‚ö†Ô∏è' :
                        data.risk_level === 'MEDIUM' ? '‚ö°' :
                            data.risk_level === 'LOW' ? 'üü°' : 'üü¢';

                let html = `
                    <div style="background: ${riskColor}22; padding: 20px; border-radius: 12px; border-left: 4px solid ${riskColor}; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; color: ${riskColor};">${riskEmoji} ${data.risk_level} RISK</h3>
                                <p style="margin: 5px 0 0 0; color: white;">${data.token_info?.symbol || 'Unknown Token'} - ${data.token_info?.name || ''}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 36px; font-weight: 700; color: ${riskColor};">${data.risk_score}</div>
                                <div style="color: #8b949e; font-size: 12px;">Risk Score</div>
                            </div>
                        </div>
                    </div>
                `;

                // Recommendation
                html += `<div style="background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <p style="margin: 0; color: white; font-weight: 600;">${data.recommendation}</p>
                </div>`;

                // Warnings
                if (data.warnings && data.warnings.length > 0) {
                    html += `<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #ef4444;">‚ö†Ô∏è Warnings (${data.warnings.length})</h4>`;
                    data.warnings.forEach(w => {
                        html += `<div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 6px; color: #fca5a5;">${w}</div>`;
                    });
                    html += `</div>`;
                }

                // Security Checks
                if (data.security_checks && Object.keys(data.security_checks).length > 0) {
                    html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #10b981; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #10b981;">üîí Security Checks</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">`;
                    Object.entries(data.security_checks).forEach(([key, check]) => {
                        const checkColor = check.status === 'SAFE' ? '#10b981' :
                            check.status === 'DANGER' ? '#ef4444' :
                                check.status === 'WARNING' ? '#f59e0b' : '#6b7280';
                        html += `<div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; border-left: 3px solid ${checkColor};">
                            <span style="color: ${checkColor};">${check.message}</span>
                        </div>`;
                    });
                    html += `</div></div>`;
                }

                // Liquidity Info
                if (data.liquidity_info && data.liquidity_info.usd) {
                    const liqColor = data.liquidity_info.usd >= 50000 ? '#10b981' :
                        data.liquidity_info.usd >= 10000 ? '#f59e0b' : '#ef4444';
                    html += `<div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <h4 style="margin: 0 0 10px 0; color: #3b82f6;">üíß Liquidity</h4>
                        <div style="display: flex; gap: 20px;">
                            <div>
                                <span style="color: #8b949e;">Total Liquidity:</span>
                                <span style="color: ${liqColor}; font-weight: 600;"> $${data.liquidity_info.usd.toLocaleString()}</span>
                            </div>
                            ${data.token_info?.age_days ? `<div>
                                <span style="color: #8b949e;">Token Age:</span>
                                <span style="color: white; font-weight: 600;"> ${data.token_info.age_days} days</span>
                            </div>` : ''}
                        </div>
                    </div>`;
                }

                resultDiv.innerHTML = html;

            } catch (e) {
                resultDiv.innerHTML = `<span style="color: #ef4444;">Error: ${e.message}</span>`;
            }
        }

        // üåä Elliott Wave function
        function openElliottWave() {
            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üåä ELLIOTT WAVE";
            document.getElementById('popupSearch').value = '';
            m.style.display = 'flex';

            b.innerHTML = `
                <div style="background: rgba(139, 92, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #8b5cf6; margin-bottom: 12px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="ewSymbol" placeholder="BTC" value="BTC"
                            style="width: 80px; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 4px; color: white; text-align: center; font-weight: 600;">
                        <select id="ewTimeframe" style="padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #374151; border-radius: 4px; color: white;">
                            <option value="1h">1H</option>
                            <option value="4h" selected>4H</option>
                            <option value="1d">1D</option>
                        </select>
                        <button onclick="analyzeElliottWave()" 
                            style="flex: 1; padding: 8px 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">
                            üåä ANALYZE
                        </button>
                    </div>
                </div>
                
                <!-- Mini Tutorial -->
                <div style="background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 12px;">
                    <div style="color: #8b949e; margin-bottom: 6px;">
                        <b style="color: #8b5cf6;">Elliott Dalga nedir?</b> Fiyatlar 5 itici dalga (1-2-3-4-5) + 3 d√ºzeltme dalgasƒ± (A-B-C) ≈üeklinde hareket eder.
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                        <div style="display: flex; align-items: end; gap: 2px;">
                            <span style="display: inline-block; width: 3px; height: 15px; background: #10b981;"></span>
                            <span style="display: inline-block; width: 3px; height: 8px; background: #ef4444;"></span>
                            <span style="display: inline-block; width: 3px; height: 25px; background: #10b981;"></span>
                            <span style="display: inline-block; width: 3px; height: 12px; background: #ef4444;"></span>
                            <span style="display: inline-block; width: 3px; height: 20px; background: #10b981;"></span>
                            <span style="font-size: 10px; color: #10b981; margin-left: 4px;">1-5</span>
                        </div>
                        <div style="display: flex; align-items: end; gap: 2px;">
                            <span style="display: inline-block; width: 3px; height: 12px; background: #ef4444;"></span>
                            <span style="display: inline-block; width: 3px; height: 8px; background: #10b981;"></span>
                            <span style="display: inline-block; width: 3px; height: 18px; background: #ef4444;"></span>
                            <span style="font-size: 10px; color: #ef4444; margin-left: 4px;">A-B-C</span>
                        </div>
                    </div>
                </div>
                
                <div id="ewResult" style="min-height: 60px;"></div>
            `;
        }

        async function analyzeElliottWave() {
            const symbol = document.getElementById('ewSymbol').value.trim() || 'BTC';
            const timeframe = document.getElementById('ewTimeframe').value;
            const resultDiv = document.getElementById('ewResult');

            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #8b949e;">üåä Analiz ediliyor...</div>';

            try {
                const res = await fetch('/api/elliott-wave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, timeframe })
                });
                const data = await res.json();

                if (data.error) {
                    resultDiv.innerHTML = `<div style="color: #ef4444; padding: 10px;">‚ùå ${data.error}</div>`;
                    return;
                }

                const trendColor = data.trend?.includes('bullish') ? '#10b981' :
                    data.trend?.includes('bearish') ? '#ef4444' : '#f59e0b';
                const trendText = data.trend?.includes('bullish') ? 'üìà Y√úKSELƒ∞≈û' :
                    data.trend?.includes('bearish') ? 'üìâ D√ú≈û√ú≈û' : '‚ÜîÔ∏è YATAY';

                let html = `
                    <!-- Header: Coin + Trend + Price -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div style="background: ${trendColor}22; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid ${trendColor};">
                            <div style="font-size: 18px; font-weight: 700; color: ${trendColor};">$${data.symbol}</div>
                            <div style="font-size: 11px; color: #8b949e;">${data.timeframe.toUpperCase()}</div>
                        </div>
                        <div style="background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 14px; font-weight: 600; color: ${trendColor};">${trendText}</div>
                            <div style="font-size: 11px; color: #8b949e;">Trend</div>
                        </div>
                        <div style="background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 14px; font-weight: 600; color: white;">$${parseFloat(data.current_price).toLocaleString()}</div>
                            <div style="font-size: 11px; color: #8b949e;">Fiyat</div>
                        </div>
                    </div>
                    
                    <!-- Current Wave Position -->
                    <div style="background: rgba(139, 92, 246, 0.15); padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #8b5cf6;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: #8b5cf6; font-weight: 600;">üìç ≈ûu an:</span>
                                <span style="color: white; font-weight: 700;">${data.current_wave?.label || 'Belirsiz'}</span>
                            </div>
                            <div style="background: ${trendColor}33; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: ${trendColor}; font-weight: 600;">
                                %${data.confidence} g√ºven
                            </div>
                        </div>
                        ${data.current_wave?.message ? `<div style="color: #d1d5db; font-size: 12px; margin-top: 6px;">${data.current_wave.message}</div>` : ''}
                    </div>
                `;

                // Wave Structure - Compact Visual
                if (data.wave_structure && data.wave_structure.length > 0) {
                    html += `<div style="background: rgba(30, 41, 59, 0.3); padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: center; gap: 4px; flex-wrap: wrap;">`;
                    data.wave_structure.forEach((wave, i) => {
                        const waveColor = wave.direction === 'up' ? '#10b981' : '#ef4444';
                        const isActive = data.current_wave?.label?.includes(wave.label);
                        html += `<span style="padding: 4px 10px; background: ${waveColor}${isActive ? '66' : '22'}; border: 1px solid ${waveColor}; border-radius: 4px; color: ${waveColor}; font-weight: 600; font-size: 12px; ${isActive ? 'box-shadow: 0 0 8px ' + waveColor + ';' : ''}">
                            ${wave.label}${wave.direction === 'up' ? '‚Üë' : '‚Üì'}
                        </span>`;
                    });
                    html += `</div></div>`;
                }

                // Signals - Compact
                if (data.signals && data.signals.length > 0) {
                    html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #10b981;">`;
                    data.signals.forEach(s => {
                        html += `<div style="color: #d1d5db; font-size: 12px; padding: 3px 0;">${s}</div>`;
                    });
                    html += `</div>`;
                }

                // Fibonacci - Super Compact
                if (data.fibonacci_levels?.retracement) {
                    const nearest = data.fibonacci_levels.nearest_level;
                    html += `<div style="background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                        <div style="font-size: 12px; color: #f59e0b; font-weight: 600; margin-bottom: 6px;">üìê Fibonacci Seviyeleri</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
                    Object.entries(data.fibonacci_levels.retracement).forEach(([level, price]) => {
                        const nearCurrent = Math.abs(price - data.current_price) / data.current_price < 0.015;
                        html += `<span style="padding: 3px 8px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 11px; ${nearCurrent ? 'border: 1px solid #f59e0b; color: #f59e0b;' : 'color: #9ca3af;'}">
                            ${level} $${parseFloat(price).toFixed(0)}
                        </span>`;
                    });
                    html += `</div></div>`;
                }

                // Recommendation - Bottom
                html += `<div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2)); padding: 10px; border-radius: 6px; margin-top: 10px; text-align: center;">
                    <div style="color: white; font-size: 13px; font-weight: 500;">${data.recommendation}</div>
                </div>`;

                resultDiv.innerHTML = html;

            } catch (e) {
                resultDiv.innerHTML = `<div style="color: #ef4444; padding: 10px;">‚ùå ${e.message}</div>`;
            }
        }

        async function api(type, e) {
            // Export i≈ülemleri i√ßin doƒürudan indirme tetikle
            if (type.includes('Export') || type.includes('Transcripts') || type.includes('YouTube')) {
                const btn = e ? (e.currentTarget || e.target.closest('.btn-item')) : null;
                const oldHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                btn.classList.add('loading');

                try {
                    window.location.href = `/api/export/${encodeURIComponent(type)}`;
                } finally {
                    setTimeout(() => {
                        btn.innerHTML = oldHTML;
                        btn.classList.remove('loading');
                    }, 2000);
                }
                return;
            }

            const m = document.getElementById('modal');
            const b = document.getElementById('modalB');
            document.getElementById('modalT').innerText = "üìä " + type.toUpperCase();
            document.getElementById('popupSearch').value = '';
            originalPopupContent = ''; // Reset search content
            m.style.display = 'flex';
            setTimeout(() => document.getElementById('popupSearch').focus(), 100);
            b.innerHTML = "<i>Generating report in Telegram format... Please wait.</i>";
            try {
                const res = await fetch(`/api/report/${encodeURIComponent(type)}`);
                const d = await res.json();
                if (d.content) {
                    // Show keeping HTML tags from Telegram (<b>, <i>)
                    b.innerHTML = d.content.replace(/\n/g, "<br>");
                    originalPopupContent = b.innerHTML; // Store for search
                } else {
                    b.innerText = "Data is not ready yet. Please wait for the analysis loop to complete.";
                }
            } catch (e) { b.innerText = "Error: " + e.message; }
        }

        function copyM() {
            const t = document.getElementById('modalB').innerText;
            // Fallback for HTTP (non-secure) contexts
            if (!navigator.clipboard) {
                const ta = document.createElement('textarea');
                ta.value = t;
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    const btn = document.querySelector('.copy-btn');
                    const originalText = btn.innerHTML; // Save original
                    btn.innerText = "COPIED! ‚úÖ";
                    setTimeout(() => {
                        btn.innerHTML = originalText; // Restore original HTML (icon + text)
                    }, 2000);
                } catch (e) { console.error('Copy failed', e); }
                document.body.removeChild(ta);
            } else {
                navigator.clipboard.writeText(t).then(() => {
                    const btn = document.querySelector('.copy-btn');
                    const originalText = btn.innerHTML; // Save original
                    btn.innerText = "COPIED! ‚úÖ";
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                });
            }
        }

        function closeM() { document.getElementById('modal').style.display = 'none'; document.getElementById('popupSearch').value = ''; }

        // Popup i√ßi arama fonksiyonu
        let originalPopupContent = '';
        function filterPopup() {
            const query = document.getElementById('popupSearch').value.toLowerCase().trim();
            const modalB = document.getElementById('modalB');

            if (!originalPopupContent) originalPopupContent = modalB.innerHTML;

            if (!query) {
                modalB.innerHTML = originalPopupContent;
                return;
            }

            // Split by <br> tags for HTML content
            const lines = originalPopupContent.split(/<br\s*\/?>/gi);
            const filtered = lines.filter(line => {
                const textOnly = line.replace(/<[^>]*>/g, '').toLowerCase();
                return textOnly.includes(query) ||
                    line.includes('---') ||
                    line.includes('üìä') ||
                    line.includes('Total') ||
                    line.includes('<b>') && line.includes('Report');
            });
            modalB.innerHTML = filtered.join('<br>');
        }

        document.getElementById('search').addEventListener('input', draw);

        // Live Alert Polling System
        async function checkAlerts() {
            try {
                const res = await fetch('/api/alerts/status');
                const data = await res.json();

                if (data.last_update && data.last_update > lastAlertTime) {
                    document.getElementById('alertBadge').style.display = 'block';
                    if (lastAlertTime > 0) {
                        showToast("üîî NEW SIGNAL!", "New technical crossover or volume surge detected in the market. Click to view.");
                    }
                }
            } catch (e) { console.error("Alert check error:", e); }
        }

        function showToast(title, msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-bolt" style="color: var(--accent); font-size: 18px;"></i>
                <div>
                    <div style="font-weight: bold; margin-bottom: 2px;">${title}</div>
                    <div style="opacity: 0.8;">${msg}</div>
                </div>
            `;
            toast.onclick = () => {
                api('Market Alerts');
                toast.remove();
            };
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 8000);
        }

        // Intercept API calls to update badge
        const originalApi = api;
        api = async function (type, e) {
            if (type === 'Market Alerts') {
                document.getElementById('alertBadge').style.display = 'none';
                const statusRes = await fetch('/api/alerts/status');
                const statusData = await statusRes.json();
                if (statusData.last_update) {
                    lastAlertTime = statusData.last_update;
                    localStorage.setItem('lastAlertTime', lastAlertTime);
                }
            }
            return originalApi(type, e);
        };

        setInterval(pull, 30000);
        setInterval(checkAlerts, 15000);
        setInterval(async () => {
            try {
                const res = await fetch('/api/report/Live%20Ticker');
                const data = await res.json();
                if (data.content) document.getElementById('liveTicker').innerText = data.content;
            } catch (e) { }
        }, 20000);

        // Update Market Regime
        async function updateRegime() {
            try {
                const res = await fetch('/api/report/Market%20Regime%20Data');
                const data = await res.json();
                if (data.content) {
                    const regime = JSON.parse(data.content);
                    const banner = document.getElementById('regimeBanner');
                    if (banner) {
                        banner.style.setProperty('--regime-color', regime.color || '#6b7280');
                        banner.style.display = 'block';

                        const emoji = document.getElementById('regimeEmoji');
                        const display = document.getElementById('regimeDisplay');
                        const desc = document.getElementById('regimeDesc');
                        const strategy = document.getElementById('regimeStrategy');
                        const fill = document.getElementById('confidenceFill');

                        if (emoji) emoji.innerText = regime.emoji || 'üîÑ';
                        if (display) display.innerText = regime.display || 'ANALYZING';
                        if (desc) desc.innerText = regime.description || 'Gathering data...';
                        if (strategy) strategy.innerText = regime.strategy || 'Wait for data';
                        if (fill) fill.style.width = `${(regime.confidence || 0) * 100}%`;
                    }
                }
            } catch (e) {
                console.error('Regime update error:', e);
                const desc = document.getElementById('regimeDesc');
                if (desc) desc.innerText = "Error loading data: " + e.message;
            }
        }

        // Update Money Flow
        async function updateMoneyFlow() {
            try {
                const res = await fetch('/api/report/Money%20Flow%20Viz');
                const data = await res.json();
                if (data.content) {
                    const flowData = JSON.parse(data.content);
                    const flowGrid = document.getElementById('flowGrid');
                    const section = document.getElementById('moneyFlowSection');

                    if (flowData.nodes && flowData.nodes.length > 1 && section && flowGrid) {
                        section.style.display = 'block';
                        flowGrid.innerHTML = '';

                        // Show top 6 flows
                        flowData.links.slice(0, 6).forEach(link => {
                            const isInflow = link.color === '#10b981';
                            const node = flowData.nodes.find(n => n.id === link.target || n.id === link.source);
                            if (node && node.id !== 'market') {
                                const div = document.createElement('div');
                                div.className = `flow-item ${isInflow ? 'inflow' : 'outflow'}`;
                                div.innerHTML = `
                                    <div class="flow-coin">${isInflow ? 'üü¢' : 'üî¥'} $${node.name}</div>
                                    <div class="flow-amount">${isInflow ? '+' : '-'}$${link.value.toFixed(1)}M</div>
                                    <div class="flow-trend">${isInflow ? 'Whale Buying' : 'Whale Selling'}</div>
                                `;
                                flowGrid.appendChild(div);
                            }
                        });
                    }
                }
            } catch (e) { console.error('Money flow update error:', e); }
        }

        async function updateMarketCashFlow() {
            try {
                const res = await fetch('/api/report/Market%20Cash%20Flow%20Data');
                const data = await res.json();
                if (data.content) {
                    const ratios = JSON.parse(data.content);
                    const dash = document.getElementById('cashFlowDashboard');
                    if (dash) {
                        dash.style.display = 'grid';
                        Object.keys(ratios).forEach(tf => {
                            const val = ratios[tf];
                            const valEl = document.getElementById(`flow-${tf}-val`);
                            const fillEl = document.getElementById(`flow-${tf}-fill`);

                            if (valEl) {
                                valEl.innerText = `${val}%`;
                                valEl.style.color = val >= 50 ? '#3fb950' : '#f85149';
                            }
                            if (fillEl) {
                                fillEl.style.width = `${val}%`;
                                fillEl.style.background = val >= 50 ? '#3fb950' : '#f85149';
                            }
                        });
                    }
                }
            } catch (e) { console.error('Cash flow dashboard update error:', e); }
        }

        setInterval(updateRegime, 45000);
        setInterval(updateMoneyFlow, 45000);
        setInterval(updateMarketCashFlow, 60000);

        pull();
        checkAlerts();
        updateRegime();
        updateMoneyFlow();
        updateMarketCashFlow();
        // RSI Heatmap Logic
        const rsiModal = document.getElementById('rsiHeatmapModal');

        function openRsiHeatmap() {
            rsiModal.style.display = 'block';
            renderHeatmap();
        }

        function closeRsiHeatmap() {
            rsiModal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == rsiModal) {
                rsiModal.style.display = 'none';
            }
        }

        async function renderHeatmap() {
            const grid = document.getElementById('rsiHeatmapGrid');
            grid.innerHTML = '<div style="color:white; text-align:center;">Loading RSI data...</div>';

            try {
                const res = await fetch('/api/data');
                const coins = await res.json();

                if (!coins || coins.length === 0) {
                    grid.innerHTML = '<div style="color:white;">No data available</div>';
                    return;
                }

                // Sort by RSI descending
                coins.sort((a, b) => (b.RSI || 50) - (a.RSI || 50));

                grid.innerHTML = '';
                coins.forEach(coin => {
                    const rsi = coin.RSI || 50;
                    let color = '#eab308'; // Neutral
                    if (rsi > 70) color = '#ef4444'; // Overbought
                    else if (rsi >= 60) color = '#f97316'; // Strong
                    else if (rsi <= 30) color = '#10b981'; // Oversold
                    else if (rsi <= 40) color = '#3b82f6'; // Weak

                    const div = document.createElement('div');
                    div.className = 'rsi-card';
                    div.style.borderTop = `3px solid ${color}`;
                    div.innerHTML = `
                        <span class="rsi-coin">$${coin.Coin.replace('USDT', '')}</span>
                        <span class="rsi-val" style="color:${color}">${Math.round(rsi)}</span>
                        <span style="font-size:10px; opacity:0.7">${rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral'}</span>
                    `;
                    grid.appendChild(div);
                });
            } catch (e) {
                console.error("Heatmap Error:", e);
                grid.innerHTML = '<div style="color:red;">Error loading heatmap</div>';
            }
        }
    </script>
</body>

</html>